(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,J,K,Q,G,Y;X=navigator.userAgent.toLowerCase(),b=X.indexOf("android")>-1,i=new AnimationHelper,w=Modernizr.touch,k=function(){return history.pushState("",document.title,window.location.pathname+window.location.search)},t=function(){if($.url().segment().indexOf("api")>-1)return history.pushState("",document.title,window.location.pathname+"#lat="+f()+"&lon="+l())},U=function(e,t){return t==null&&(t=35),e.truncate(t)},m=function(){return setTimeout(function(){return window.scrollTo(0,1)},0)},O=0,M=0,o=41.882861797196774,u=-87.6288092136383,G=null,Y=null,f=function(){return y(O,M)?O:o},l=function(){return y(O,M)?M:u},c=function(){return y(G,Y)?G:null},h=function(){return y(G,Y)?Y:null},y=function(e,t){return e&&t&&parseInt(t)<=0?!0:!1},Q=function(){var e;e=function(e){return G=e.coords.latitude,Y=e.coords.longitude};if(typeof navigator.geolocation!="undefined")try{return navigator.geolocation.getCurrentPosition(e)}catch(t){}else if(typeof google.gears!="undefined")try{return google.gears.factory.create("beta.geolocation").getCurrentPosition(e)}catch(t){}},e=function(){var e,n,r,i,s,o,u,a,p,d,v,m,g,y,b,w,E,S,x,T,N;return N=15,y=18,g=null,s=null,S=null,T=!1,E="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",w='&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',b=L.tileLayer(E,{maxZoom:y,attribution:w}),a="b15d31099abc4367abc772db04a74cf9",d=87150,v="http://{s}.tile.cloudmade.com/"+a+"/"+d+"/256/{z}/{x}/{y}.png",p='&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',u=L.tileLayer(v,{maxZoom:y,attribution:p}),o=L.icon({iconUrl:"assets/eta-map-marker.png",iconRetinaUrl:"assets/eta-map-marker.png",iconSize:[120,120],iconAnchor:[120,120]}),x=L.icon({iconUrl:"assets/user-map-marker.png",iconRetinaUrl:"assets/user-map-marker.png",iconSize:[30,30],iconAnchor:[30,30]}),n=function(e){var t;return e==null&&(e="map"),t=!0,window.Touch&&(t=!1),g=L.map(e,{zoomControl:t}).setView([f(),l()],N).addLayer(u)},e=function(){return s=L.marker([f(),l()],{icon:o}).addTo(g)},i=function(){if(c()&&h())return S=L.marker([c(),h()],{icon:x}).addTo(g)},r=function(){return g.on("move",function(){return O=g.getCenter().lat,M=g.getCenter().lng,J(),t()})},m=function(){return r()},{initialize:function(){if(!g)return n(),i(),m(),S?$(".js-set-map-to-user-location").on("click",function(){return console.log(g.getZoom()),g.setView([c(),h()],g.getZoom())}):$(".js-set-map-to-user-location").hide()},changeMapLocation:function(){if(g)return g.setView([f(),l()],N)},setVisibility:function(e){return e===!0?T=!0:T=!1},isVisible:function(){return T},disableDragging:function(){if(g)return $("#map-curtain").show(),g.off("move"),$("body").bind("touchmove",function(e){return e.preventDefault()})},enableDragging:function(){if(g)return r(),$("#map-curtain").hide(),$("body").unbind("touchmove")}}}(),window.updateLinkUrlForIOs=function(e){var t;return t=document.getElementById(e),$(t).unbind("touchend").bind("touchend",function(){var e;return e=$(this).attr("href"),$(this).attr("href","#!"+e)}),$(t).parent().hasClass("all-stops")?$(t).unbind("click").bind("click",function(e){var t,n;return n=$(this).parent(),$(this).hide(),n.next().next().hide(),n.next().show(),t=$(this).attr("href"),t.indexOf("#!")===0&&(t=t.substr(2)),$(this).attr("href",t)}):$(t).unbind("click").bind("click",function(){var e;return e=$(this).attr("href"),e.indexOf("#!")===0&&(e=e.substr(2)),$(this).attr("href",e)})},K=function(e){var t,n,r;r=[];for(t in e)n=e[t],n.addEventListener?($(n).unbind("touchend").bind("touchend",function(){var e;return e=$(this).attr("href"),$(this).attr("href","#!"+e)}),$(n).parent().hasClass("all-stops")?r.push($(n).unbind("click").bind("click",function(e){var t,n;return n=$(this).parent(),$(this).hide(),n.next().next().hide(),n.next().show(),t=$(this).attr("href"),t.indexOf("#!")===0&&(t=t.substr(2)),$(this).attr("href",t)})):r.push($(n).unbind("click").bind("click",function(){var e;return e=$(this).attr("href"),e.indexOf("#!")===0&&(e=e.substr(2)),$(this).attr("href",e)}))):r.push(void 0);return r},s=function(e){var t;return e===0?t="<span class='less'>Now</span>":t=e,t},r=function(e,t){var n;return t=s(t),b?e.html(t):(n=e.attr("id"),i.doMoveLeft(n,-120,!0,function(){return e.css("left","120px"),e.html(t),i.doMoveLeft(n,0,!1,function(){return e.css("opacity",1)})}))},n=function(e,t){var n;return t=s(t),b?e.html(t):(n=e.attr("id"),i.doMoveRight(n,120,!0,function(){return e.css("left","-120px"),e.html(t),i.doMoveRight(n,0,!1,function(){return e.css("opacity",1)})}))},T=function(e,t){var n;n=t.length;while(n--)t[n].className=" ";return t[e].className="active"},S=function(e,t,n){var i,s;return i=n.data("current"),i<t.length-1?i+=1:i=0,s=n.find(".min"),r(s,t[i]),n.data("current",i),T(i,e)},A=function(e,t,r){var i,s;return i=r.data("current"),i>0?i-=1:i=t.length-1,s=r.find(".min"),n(s,t[i]),r.data("current",i),T(i,e)},window.add_sliders=function(e){var t,n;return e!==void 0?($(e).hasClass("slider")?n=$(e).attr("id"):n=$(e).find(".slider").attr("id"),t=$(".slider#"+n)):t=$(".slider"),jQuery.each(t,function(){var e,t,n,r,i,s;t=$(this),i=t.attr("id"),s=i.replace("veh_",""),n=t.data("min"),e=$("#nav_veh_"+s+" > li"),r=t.parents(".swipe")[0],r.onmousedown=null,r.onmouseup=null,r.onmousemove=null,r.ontouchstart=null,r.ontouchmove=null,r.ontouchend=null,r.ontouchcancel=null,r.ontouchleave=null;if(n.length>1)return w?t.parents(".swipe").simpleTouch({swipe_left:function(){return A(e,n,t)},swipe_right:function(){return S(e,n,t)}}):($(r).css("cursor","pointer"),$(r).unbind().bind("click",function(r){return S(e,n,t),!1}))})},g=function(){return $(".loading").hide(),$(".footer-loading").hide()},P=function(){return $("#refresh-wrap").addClass("refresh-window"),$("#refresh-wrap-header").addClass("refresh-window-header")},d=function(){return $("#refresh-wrap").removeClass("refresh-window"),$("#refresh-wrap-header").removeClass("refresh-window-header")},H=function(){return I(),$("section, .no-geolocation, .location h2, .location h3").hide(),$(".error").show(),$(".location h2").html(""),$(".location-error").html("Unable to retrieve data"),$(".location-error").show(),$(".location-error-2, .refresh").hide(),$(".header-location-hint").hide(),z()},v=function(){return $(".no-geolocation, .location-error, .location-error-2, .error").hide(),$("header, footer, .location h2, .location h3, section, .refresh, .header-location-hint").show()},C=function(){return $(".refresh-button").unbind("click").bind("click",function(){return N(),!1}),$(".refresh-location").unbind("click").bind("click",function(){return x(),!1}),$(".reload-application").unbind("click").bind("click",function(){return window.location.reload(),!1}),$(".change-address").unbind("click").bind("click",function(){return _(),!1}),$(".js-leave-feedback").unbind("click").bind("click",function(){return E(),!1}),$(".slide-to-map").unbind("click").bind("click",function(){return q(),!1}),$(".slide-to-list").unbind("click").bind("click",function(){return I(),x(),!1})},W=function(){return $(".header-location-icon").addClass("slide-to-map")},z=function(){return $(".header-location-icon").removeClass("slide-to-map")},q=function(t){var n;return t==null&&(t=!0),d(),z(),e.initialize(),t?($(".timelist-slide").css("position","relative").animate({right:"-100%"},400),$(".map-slide").animate({left:"0%"},400,function(){return $(".address-marker").show(),$(window).scrollTop(0)})):($(".timelist-slide").css("position","relative").css("right","-100%"),$(".map-slide").css("left","0%"),$(".address-marker").show(),$(window).scrollTop(0)),v(),$(".location h2").removeClass("slide-to-map"),n=$(".location h2").html(),$(".location h2").hide(),$(".location-form").show(),$(".location-form input#address").attr("value",n),$(".location-form input#address").width($(".logo").width()-$(".header-location-icon").outerWidth()-$(".header-controls").outerWidth()-120),$("header .header-controls .refresh").hide(),$("header .header-controls .next").show(),e.setVisibility(!0),C()},I=function(){return W(),$(window).scrollTop(0),$(".map-slide").animate({left:"-100%"},400),$(".address-marker").hide(),$(".timelist-slide").animate({right:"0%"},400,function(){return $(this).css("position","static")}),$(".location h2").removeClass("change-address"),$(".location h2").addClass("slide-to-map"),$(".location-form").hide(),$(".location h2").show(),$("header .header-controls .next").hide(),$("header .header-controls .refresh").show(),e.setVisibility(!1),C()},J=function(){var e;return e=new google.maps.Geocoder,e.geocode({location:new google.maps.LatLng(f(),l(),!1)},function(e,t){var n;if(t===google.maps.GeocoderStatus.OK)return n=e[0].formatted_address.substring(0,e[0].formatted_address.indexOf(",")),D(n)})},D=function(e){return e==null&&(e=""),$(".location-form input#expanded_address").val(e),$(window).width()<480&&(e=U(e)),$(".location h2").html(e),$(".location-form input#address").val(e)},B=function(){var e;return e=$(".location-form input#expanded_address").val(),$(".location-form input#address").val(e)},j=function(){var e;return e=$(".location-form input#address").val(),$(".location-form input#address").val(U(e))},_=function(n){var r,i;n==null&&(n=!0),n?r=prompt("Please input address:",$(".chosen-address").html()):r=$(".location-form input#expanded_address").val();if(r)return r+=", Chicago, Illinois",i=new google.maps.Geocoder,i.geocode({address:r},function(t,n){if(n!==google.maps.GeocoderStatus.OK)return V(r);O=t[0].geometry.location.lat(),M=t[0].geometry.location.lng(),J(),e.changeMapLocation();if(!e.isVisible())return q()}),t()},V=function(e){return $.ajax({url:"/unable_to_geocode_address",dataType:"html",data:{lat:O,lon:M},success:function(t){return $("section").html(t),D(e),v(),$(".refresh").hide()},error:function(){return H()},complete:function(){var e;return add_sliders(),e=document.getElementsByTagName("a"),K(e),I(),$(".location h2").removeClass("slide-to-map"),C(),d()}})},x=function(){return P(),$.ajax({url:"/list.json",dataType:"json",data:{lat:f(),lon:l()},success:function(e){g(),$("section").html(e.content),D(me),v();if(!e.any_routes)return $(".refresh").hide()},error:function(){return g(),H()},complete:function(){var e;return add_sliders(),e=document.getElementsByTagName("a"),K(e),C(),t(),$(".refresh-button").removeClass("in-progress"),d()}})},N=function(){var e,t;if($(".refresh-button").hasClass("in-progress"))return;$(".refresh-button").addClass("in-progress"),P(),t=[],$('.js-stop[data-stop-type="bus"]').each(function(){return t.push($(this).find(".slider").data("stop-id").split("_").slice(-1)[0])}),$('.js-stop[data-stop-type="train"]').each(function(){return t.push($(this).find(".slider").data("stop-id").split("_").slice(-2)[0])}),e=function(e){var n;return n={old_lat:f(),old_lon:l(),stops:t},e&&y(e.coords.latitude,e.coords.longitude)&&(n.lat=e.coords.latitude,n.lon=e.coords.longitude,G=e.coords.latitude,Y=e.coords.longitude),$.ajax({url:"/get_updated_predictions.json",dataType:"json",data:n,success:function(t){var n,r,i,s,o,u,a;if(t.need_list_refresh)return e&&y(e.coords.latitude,e.coords.longitude)&&(O=e.coords.latitude,M=e.coords.longitude),x();D(me),u=t.buses;for(r in u)i=u[r],n=$('.slider[id="veh_'+r+'"]'),n&&(o=n.parents(".time"),o.html(i.html));a=t.trains;for(r in a)i=a[r],n=$('.slider[id="veh_'+r+'"]'),n&&(o=n.parents(".time"),o.html(i.html));return v(),add_sliders(),$(".cta-api-error").hide(),s=document.getElementsByTagName("a"),K(s),C(),setTimeout(function(){return $(".refresh-button").removeClass("in-progress"),d()},1e3)},error:function(){var e;return H(),add_sliders(),$(".cta-api-error").hide(),e=document.getElementsByTagName("a"),K(e),C(),setTimeout(function(){return $(".refresh-button").removeClass("in-progress"),d()},1e3)},complete:function(){if(e&&y(e.coords.latitude,e.coords.longitude))return O=e.coords.latitude,M=e.coords.longitude}})};if(typeof navigator.geolocation!="undefined")try{return navigator.geolocation.getCurrentPosition(e)}catch(n){}else{if(typeof google.gears=="undefined")return e();try{return google.gears.factory.create("beta.geolocation").getCurrentPosition(e)}catch(n){}}},E=function(){var e,t,n,r,i,s,o,u,a,f;if($(".js-leave-feedback").hasClass("in-progress"))return;a=prompt("Your comment: ");if(a)return $(".js-leave-feedback").addClass("in-progress"),i=M,n=O,r=$(".location h2").html(),o=window.screen.height,u=window.screen.width,window.devicePixelRatio&&(s=window.devicePixelRatio,e=o*window.devicePixelRatio,t=u*window.devicePixelRatio),f=navigator.userAgent,$.ajax({type:"POST",url:"feedbacks/post.json",data:{text:a,longitude:i,latitude:n,location:r,screen_height:o,screen_width:u,pixel_ratio:s,device_screen_height:e,device_screen_width:t,user_agent:f},success:function(e){var t,n;return e.success?(n=$(".footer-leave-feedback").html(),t=$(".footer-leave-feedback-hint").html(),$(".footer-leave-feedback").html("Thank you!"),$(".footer-leave-feedback-hint").html("We're on it"),setTimeout(function(){return $(".footer-leave-feedback").html(n),$(".footer-leave-feedback-hint").html(t),$(".js-leave-feedback").removeClass("in-progress")},5e3)):$(".js-leave-feedback").removeClass("in-progress")},error:function(){return console.log("Error while trying to leave feedback"),$(".js-leave-feedback").removeClass("in-progress")},dataType:"json"})},R=function(n,r){return r==null&&(r=!1),O=n.coords.latitude,M=n.coords.longitude,r?Q():(G=n.coords.latitude,Y=n.coords.longitude),$.ajax({url:"/list.json",dataType:"json",data:{lat:f(),lon:l(),dev:dev},success:function(e){$("section").html(e.content),D(me),v();if(!e.any_routes)return $(".refresh").hide()},error:function(){return H()},complete:function(){var n;return t(),e.initialize(),g(),add_sliders(),n=document.getElementsByTagName("a"),K(n),C(),document.getElementById("refresh-wrap").addEventListener("touchstart",function(e){return e.preventDefault()})}})},a=function(e){var t;C(),$(".location h3, .loader").hide(),$(".refresh").hide(),$("header").show(),$("footer").show(),t="";if(!e)return t="Sorry, there was an error",F();switch(e.code){case e.PERMISSION_DENIED:return console.log(e.code),t="You choose not to share geolocation data",F();case e.POSITION_UNAVAILABLE:return console.log(e.code),t="Sorry, we couldn't determine your location",F();case e.TIMEOUT:return console.log(e.code),t="Sorry, the location request time out",F();default:return t="Sorry, there was an error",F()}},F=function(){return q(!1),e.changeMapLocation(),J(),t()},p=function(){var e,t;if($.url().segment().indexOf("api")>-1&&$.url().fparam("lat")&&$.url().fparam("lon"))return e={coords:{latitude:parseFloat($.url().fparam("lat")),longitude:parseFloat($.url().fparam("lon"))}},R(e,!0);if(typeof navigator.geolocation!="undefined")try{return navigator.geolocation.getCurrentPosition(R,a,{timeout:5e3})}catch(n){}else{if(typeof google.gears=="undefined")return a();try{return t=google.gears.factory.create("beta.geolocation"),t.getCurrentPosition(R,a,{timeout:5e3})}catch(n){}}},window.onload=function(){return m(),$(".location-form").bind("submit",function(e){return D($(this).find("input#address").val()),_(!1),$(".location-form input").blur(),!1}),$(".location-form input#address").bind("click",function(){return B(),window.Touch?(e.disableDragging(),this.selectionStart=0,this.selectionEnd=this.value.length):$(this).select()}),$(".location-form input#address").bind("focusout",function(){j();if(window.Touch)return e.enableDragging()}),p()}}).call(this);